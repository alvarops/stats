%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Scalable Computing Assignment
%
% This file is based on a template downloaded from:
% http://www.latextemplates.com
%
% Original author of the template:
% Ted Pavlic (http://www.tedpavlic.com)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass{article}

\usepackage{fancyhdr} % Required for custom headers
\usepackage{lastpage} % Required to determine the last page for the footer
\usepackage{extramarks} % Required for headers and footers
\usepackage[usenames,dvipsnames]{color} % Required for custom colors
\usepackage{graphicx} % Required to insert images
\usepackage{listings} % Required for insertion of code
\usepackage{courier} % Required for the courier font
\usepackage{caption}

% Margins
\topmargin=-0.45in
\evensidemargin=0in
\oddsidemargin=0in
\textwidth=6.5in
\textheight=9.0in
\headsep=0.25in

\linespread{1.1} % Line spacing

% Set up the header and footer
\pagestyle{fancy}
\lhead{\hmwkAuthorName} % Top left header
\chead{\hmwkClass\ (\hmwkClassInstructor): \hmwkTitle} % Top center head
\rhead{\firstxmark} % Top right header
\lfoot{\lastxmark} % Bottom left footer
\cfoot{} % Bottom center footer
\rfoot{Page\ \thepage\ of\ \protect\pageref{LastPage}} % Bottom right footer
\renewcommand\headrulewidth{0.4pt} % Size of the header rule
\renewcommand\footrulewidth{0.4pt} % Size of the footer rule

\setlength\parindent{0pt} % Removes all indentation from paragraphs

%----------------------------------------------------------------------------------------
%	CODE INCLUSION CONFIGURATION
%----------------------------------------------------------------------------------------

\definecolor{MyDarkGreen}{rgb}{0.0,0.4,0.0} % This is the color used for comments
\lstloadlanguages{C} % Load C syntax for listings, for a list of other languages supported see: ftp://ftp.tex.ac.uk/tex-archive/macros/latex/contrib/listings/listings.pdf
\lstset{language=C, % Use C in this example
        frame=single, % Single frame around code
        basicstyle=\small\ttfamily, % Use small true type font
        keywordstyle=[1]\color{Blue}\bf, % C functions bold and blue
        keywordstyle=[2]\color{Purple}, % C function arguments purple
        keywordstyle=[3]\color{Blue}\underbar, % Custom functions underlined and blue
        identifierstyle=, % Nothing special about identifiers                                         
        commentstyle=\usefont{T1}{pcr}{m}{sl}\color{MyDarkGreen}\small, % Comments small dark green courier font
        stringstyle=\color{Purple}, % Strings are purple
        showstringspaces=false, % Don't put marks in string spaces
        tabsize=5, % 5 spaces per tab
        %
        % Put standard C functions not included in the default language here
        morekeywords={rand},
        %
        % Put C function parameters here
        morekeywords=[2]{on, off, interp},
        %
        % Put user defined functions here
        morekeywords=[3]{test},
       	%
        morecomment=[l][\color{Blue}]{...}, % Line continuation (...) like blue comment
        numbers=left, % Line numbers on left
        firstnumber=1, % Line numbers start with line 1
        numberstyle=\tiny\color{Blue}, % Line numbers are blue and small
        stepnumber=5 % Line numbers go in steps of 5
}

% Creates a new command to include a C script, the first parameter is the filename of the script (without .c), the second parameter is the caption
\newcommand{\cscript}[2]{
\begin{itemize}
\item[]\lstinputlisting[caption=#2,label=#1]{#1.c}
\item[]\lstinputlisting[caption=Corresponding header file,label=#1.h]{#1.h}
\end{itemize}
}

%----------------------------------------------------------------------------------------
%	DOCUMENT STRUCTURE COMMANDS
%	Skip this unless you know what you're doing
%----------------------------------------------------------------------------------------

% Header and footer for when a page split occurs within a problem environment
\newcommand{\enterProblemHeader}[1]{
\nobreak\extramarks{#1}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
}

% Header and footer for when a page split occurs between problem environments
\newcommand{\exitProblemHeader}[1]{
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1}{}\nobreak
}

\setcounter{secnumdepth}{0} % Removes default section numbers
\newcounter{homeworkProblemCounter} % Creates a counter to keep track of the number of problems

\newcommand{\homeworkProblemName}{}
\newenvironment{homeworkProblem}[1][Q. \arabic{homeworkProblemCounter}]{ % Makes a new environment called homeworkProblem which takes 1 argument (custom name) but the default is "Problem #"
\stepcounter{homeworkProblemCounter} % Increase counter for number of problems
\renewcommand{\homeworkProblemName}{#1} % Assign \homeworkProblemName the name of the problem
\section{\homeworkProblemName} % Make a section in the document with the custom problem count
\enterProblemHeader{\homeworkProblemName} % Header and footer within the environment
}{
\exitProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

\newcommand{\problemAnswer}[1]{ % Defines the problem answer command with the content as the only argument
\noindent\framebox[\columnwidth][c]{\begin{minipage}{0.98\columnwidth}#1\end{minipage}} % Makes the box around the problem answer and puts the content inside
}

\newcommand{\homeworkSectionName}{}
\newenvironment{homeworkSection}[1]{ % New environment for sections within homework problems, takes 1 argument - the name of the section
\renewcommand{\homeworkSectionName}{#1} % Assign \homeworkSectionName to the name of the section from the environment argument
\subsection{\homeworkSectionName} % Make a subsection with the custom name of the subsection
\enterProblemHeader{\homeworkProblemName\ [\homeworkSectionName]} % Header and footer within the environment
}{
\enterProblemHeader{\homeworkProblemName} % Header and footer after the environment
}


%----------------------------------------------------------------------------------------
%	NAME AND CLASS SECTION
%----------------------------------------------------------------------------------------

\newcommand{\hmwkTitle}{CA\ \#3} % Assignment title
\newcommand{\hmwkDueDate}{Monday,\ May\ 6th,\ 2013} % Due date
\newcommand{\hmwkClass}{Scalable Computing} % Course/class
\newcommand{\hmwkClassTime}{} % Class/lecture time
\newcommand{\hmwkClassInstructor}{Dr. John Burns} % Teacher/lecturer
\newcommand{\hmwkAuthorName}{Alvaro Pereda} % Your name

%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------

\title{
\vspace{2in}
\textmd{\textbf{\hmwkClass:\ \hmwkTitle}}\\
\normalsize\vspace{0.1in}\small{Due\ on\ \hmwkDueDate}\\
\vspace{0.1in}\large{\textit{\hmwkClassInstructor\ \hmwkClassTime}}
\vspace{3in}
}

\author{\textbf{\hmwkAuthorName}}
\date{} % Insert date here if you want it to appear below your name

%----------------------------------------------------------------------------------------

\begin{document}

\maketitle

%----------------------------------------------------------------------------------------
%	TABLE OF CONTENTS
%----------------------------------------------------------------------------------------

%\setcounter{tocdepth}{1} % Uncomment this line if you don't want subsections listed in the ToC

\newpage
\tableofcontents
\newpage

%----------------------------------------------------------------------------------------
%	PROBLEM 1
%----------------------------------------------------------------------------------------

% To have just one problem per page, simply put a \clearpage after each problem

\begin{homeworkProblem}

\begin{homeworkSection}{Part 1:}
We wish to find the maximum, minimum and mean value in an array of 500 random integers between 0 and 1000. Write a C/C++ program to achieve this. You are NOT permitted to use any libraries for
this - you must implement all aspects of the program yourself. If you use any libraries you will score 0 for this section. Use the timing methodology from the labs to demonstrate the wall-clock performance of this solution.\\
\problemAnswer{
Listing \ref{noscal/statistics-threads} shows the algorithm implementation in C. The problem has been divided in three functions:
\begin{itemize}
\item The \emph{main} function, that schedules the calls to the other functions, sets the timers up and displays the results.
\item The \emph{build} function, that with calls to the mathematical pseudo random numbers generatior \emph{rand()} initializes the integer array.
\item The \emph{stats} function, that collects the max value, min and average.
\end{itemize}
In order to collect the results, a struct has been implemented as can be seen in Listing \ref{noscal/statistics-threads.h}. The loop printing the results has been commented out.\\
The results are as follows: \\
Start\\
Avg = 47\\
\\
Max = 99\\
\\
Min = 0\\
Static: Elapsed: 0.000082 seconds\\
}
\cscript{noscal/statistics-threads}{No parallel implementation in C.}
\end{homeworkSection}
\begin{homeworkSection}{Part 2:}
Next, discuss in no less than 500 words how each and every part of your program could be executed in parallel.\\
\problemAnswer{
The program listed in Listing \ref{noscal/statistics-threads} can be divided in two main phases: setup of the array with random integers, and the processing of that array, extracting the required statistics. There is a clear opportunity to parallelize each phase. \\
In order to parallelize the array building, the build method needs to be prepared for multithreading. To achieve that, the array will be sliced in as many subdivisions as threads are required, so each thread will access a given subdivision of the array. Ideally the size of the array, and the number of threads should be divisible, so all subdivisions are the same size.\\
The Listing \ref{../src/statistics-threads} in line 110 displays the implementation of the array start up with random numbers in a parallelized manner.\\
In order to run it, a thread starter method has been implemented, and can be read from the line 91 onwards. That method will also been called at other stages of the program, with the phase method as parameter.\\
The second phase is the processing of the array. There are two main approaches to solve the problem:
\begin{itemize}
\item Use one loop for each phase of the statistics, one to get the maximum value, next loop to get the minimum value and one final, to get the average value. 
\item Perform all calculations in one single loop. 
\end{itemize}
Even though there are three loops in the first proposal, its theoretic cost would be the same as the second: O(n) and the implementation is the simplest. On the other hand, the second implementation is shorter in lines of code and therefore will feature less bugs, more powerful and scalable code.
There are three main ways to parallelize this second phase. 
\begin{itemize}
\item One would be using one thread for each loop, having three threads calculating the maximum, minimum and average respectively. 
\item The second one would be slicing the array again in as many subdivisions as threads, performing all of them the maximum calculation, then the minimum and finally the average. That could be done with a join between each loop, having three phases of thread creation for each slice, or using one final join, once the calculation work is done, which is more optimum. 
\item Finally, the third approach would be useful in a massively parallelized environment, where multiple threads can be used seamlessly; in that case the workload could be divided horizontally, slicing the original array in as many subdivisions as one third of the processors available, and vertically, letting three threads access to the same values, one of each performing one of the main calculations (maximum, minimum and average). 
\end{itemize}
Of the three solutions proposed, the first approach is the less scalable, as if there were more processors or threads, they would not be used. The third one is the most powerful and difficult to implement, given the complexity of the main problem, and the fact that current available CPUs feature up to 8 cores, could seem like overkill. 
After this second phase, there will be the summary, where the results of each thread are merged in the final response.

The implementation and execution with CUDA of the horizontal and vertical scalability would be a interesting future line of investigation.
}

\end{homeworkSection}
\begin{homeworkSection}{Part 3.}
Using pthreads, implement your analysis from part 2. to build a parallel solution. Demonstrate the results of this in your answer PDF to show the maximum, minimum and mean are correct. To do this, it is best to run the serial code followed by the parallel code. In this section you will be marked on correctness of the solution. You must make sure that workload is evenly distributed across threads and the threads must all execute separate and independent computations.\\
\problemAnswer{
The implementation discussed in the second Part of this assignment, can be read in Listing \ref{../src/statistics-threads}\\
The result is:\\
Start\\
static build: Elapsed: 0.000049 seconds\\
Avg = 508.8200\\
Max = 997\\
Min = 0\\
Static stats: Elapsed: 0.000009 seconds\\
Avg = 508.8200\\
Max = 997\\
Min = 0\\
dynamic stats: Elapsed: 0.000385 seconds\\
}
\cscript{../src/statistics-threads}{Parallel implementation in C.}

\end{homeworkSection}
\end{homeworkProblem}

%----------------------------------------------------------------------------------------

\end{document}